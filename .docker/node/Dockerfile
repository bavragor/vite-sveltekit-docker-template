# Dockerfile

# Step 1: Read the Node.js version from .nvmrc (or default)
ARG NODE_VERSION
FROM node:${NODE_VERSION} AS base

FROM base AS system
# Playwright uses bash
RUN apt update && apt install bash
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ARG UID
ARG GID

RUN groupmod -g ${GID} node \
    && usermod -u ${UID} -g ${GID} node \
    && chown -R node:node /home/node

ARG PNPM_VERSION=${PNPM_VERSION}
RUN npm install -g pnpm@${PNPM_VERSION}

FROM system AS playwright
# Playwright 1.47.1 Dependencies
RUN apt-get install -y --no-install-recommends libasound2 libatk-bridge2.0-0 libatk1.0-0 libatspi2.0-0 libcairo2 libcups2 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0 libnspr4 libnss3 libpango-1.0-0 libx11-6 libxcb1 libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 libxrandr2 xvfb fonts-noto-color-emoji fonts-unifont libfontconfig1 libfreetype6 xfonts-scalable fonts-liberation fonts-ipafont-gothic fonts-wqy-zenhei fonts-tlwg-loma-otf fonts-freefont-ttf libcairo-gobject2 libdbus-glib-1-2 libgdk-pixbuf-2.0-0 libgtk-3-0 libharfbuzz0b libpangocairo-1.0-0 libx11-xcb1 libxcb-shm0 libxcursor1 libxi6 libxrender1 libxtst6 libsoup-3.0-0 gstreamer1.0-libav gstreamer1.0-plugins-bad gstreamer1.0-plugins-base gstreamer1.0-plugins-good libegl1 libenchant-2-2 libepoxy0 libevdev2 libgles2 libglx0 libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgudev-1.0-0 libharfbuzz-icu0 libhyphen0 libicu72 libjpeg62-turbo liblcms2-2 libmanette-0.2-0 libnotify4 libopengl0 libopenjp2-7 libopus0 libpng16-16 libproxy1v5 libsecret-1-0 libwayland-client0 libwayland-egl1 libwayland-server0 libwebp7 libwebpdemux2 libwoff1 libxml2 libxslt1.1 libatomic1 libevent-2.1-7

FROM playwright AS app

USER node

WORKDIR /home/node/app

# Step 4: Ensure pnpm store directory exists and set proper permissions
RUN mkdir -p /home/node/app/.pnpm-store && chown -R node:node /home/node/app/.pnpm-store

RUN mkdir -p /home/node/app/build && chown -R node:node /home/node/app/build
RUN mkdir -p /home/node/app/dist && chown -R node:node /home/node/app/dist

# Step 5: Set environment variable for pnpm store
ENV PNPM_STORE_PATH=/home/node/app/.pnpm-store

COPY --chown=node:node . .
